<div class="top-container">

  <%# --- æ¤œç´¢ã‚¨ãƒªã‚¢ --- %>
  <div class="search-area">
    <%= form_with(url: root_path, method: :get, local: true, class: "search-form") do |f| %>
      
      <%# --- â‘  ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ --- %>
      <%= f.select :search_type, 
                   [['åº—èˆ—åæ¤œç´¢', 'name'], ['ã‚¨ãƒªã‚¢æ¤œç´¢', 'area']], 
                   { selected: params[:search_type] }, 
                   { 
                     class: "search-select",
                     id: "search-type-select",
                     # ä½æ‰€ãƒ‡ãƒ¼ã‚¿ï¼ˆaddressã§ã¯ãªãcityã‚’ä½¿ç”¨ï¼‰
                     data: { user_area: session[:user_id] ? current_user&.city : "" } 
                   } %>

      <%# --- â‘¡ ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ --- %>
      <%= f.text_field :keyword, 
                       value: params[:keyword], 
                       placeholder: "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...", 
                       class: "search-input",
                       id: "search-keyword-input" %>

      <%= f.submit "æ¤œç´¢", class: "search-btn" %>
    <% end %>
  </div>

  <%# --- â‘¢ JavaScript --- %>
  <script>
    document.addEventListener("turbo:load", function() {
      // è¦ç´ ã‚’å–å¾—
      const searchSelect = document.getElementById("search-type-select");
      const searchInput = document.getElementById("search-keyword-input");

      // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å‡¦ç†ã‚’ã—ãªã„ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
      if (!searchSelect || !searchInput) return;

      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
      searchSelect.addEventListener("change", function() {
        
        // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½æ‰€ã‚’å–å¾—
        const userAddress = this.getAttribute("data-user-area");

        if (this.value === "area") {
          // ã€Œã‚¨ãƒªã‚¢æ¤œç´¢ã€ãŒé¸ã°ã‚ŒãŸæ™‚
          if (userAddress) {
            searchInput.value = userAddress; // ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›
          } else {
            // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ã€ã¾ãŸã¯ä½æ‰€æœªç™»éŒ²ã®å ´åˆ
            searchInput.placeholder = "ã‚¨ãƒªã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
          }
        } else {
          // ã€Œåº—èˆ—åæ¤œç´¢ã€ã«æˆ»ã£ãŸæ™‚
          searchInput.value = "";
          searchInput.placeholder = "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...";
        }
      });
    });
  </script>

  <%# --- ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ --- %>
  <div class="shop-list">
    <% @shops.each do |shop| %>
      <div class="shop-card">
        <div class="shop-content">
          
          <%# å·¦å´ï¼šç”»åƒ %>
          <div class="shop-image">
            <% if shop.image.attached? %>
              <%= image_tag shop.image, class: "shop-img-tag" %>
            <% else %>
              <div class="no-image-text">No Image</div>
            <% end %>
          </div>

          <%# å³å´ï¼šæƒ…å ± %>
          <div class="shop-info">
            <div class="shop-name-box">
              <%# items_pathï¼ˆå•†å“ä¸€è¦§ï¼‰ã¸ã€shop_idï¼ˆã©ã®åº—ã®ãƒœã‚¿ãƒ³ã‹ï¼‰ã‚’æŒã£ã¦ç§»å‹•ã™ã‚‹ %>
              <%= link_to shop.name, items_path(shop_id: shop.id), class: "shop-name-link" %>
            </div>
            
            <% if session[:user_id] %>
              <div class="shop-edit-area">
                <%# ç·¨é›†ãƒœã‚¿ãƒ³ %>
                <%= link_to 'ç·¨é›†ã™ã‚‹', edit_shop_path(shop), class: "edit-btn" %>
                
                <%# å‰Šé™¤ãƒœã‚¿ãƒ³ %>
                <%= link_to 'å‰Šé™¤ã™ã‚‹', shop_path(shop), 
                    data: { turbo_method: :delete, turbo_confirm: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" }, 
                    class: "edit-btn is-delete" %>
              </div>
            <% end %>
            
            <div class="shop-like-area">
              <% if session[:user_id] %>
                <%# --- ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆæ©Ÿèƒ½ã‚ã‚Šï¼‰ --- %>
                <% if shop.likes.exists?(user_id: session[:user_id]) %>
                  <%# è§£é™¤ãƒœã‚¿ãƒ³ %>
                  <%= button_to shop_likes_path(shop), method: :delete, class: "like-btn liked" do %>
                    ã„ã„ã­è§£é™¤ <span class="thumbs-up">ğŸ‘</span>
                    <span class="like-count"><%= shop.likes.count %></span>
                  <% end %>
                <% else %>
                  <%# ç™»éŒ²ãƒœã‚¿ãƒ³ %>
                  <%= button_to shop_likes_path(shop), method: :post, class: "like-btn" do %>
                    ã„ã„ã­ <span class="thumbs-up">ğŸ‘</span>
                    <span class="like-count"><%= shop.likes.count %></span>
                  <% end %>
                <% end %>

              <% else %>
                <%# --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ï¼ˆæ©Ÿèƒ½ãªã—ãƒ»é£¾ã‚Šãƒœã‚¿ãƒ³ï¼‰ --- %>
                <button type="button" class="like-btn">
                  ã„ã„ã­ <span class="thumbs-up">ğŸ‘</span>
                  <span class="like-count"><%= shop.likes.count %></span>
                </button>
              <% end %>
            </div>
            
          </div>
        </div>

        <%# ä¸‹éƒ¨ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ %>
        <div class="shop-review-bar">
          <%= link_to "ãƒ¬ãƒ“ãƒ¥ãƒ¼", shop_path(shop), class: "review-link" %>
        </div>
      </div>
    <% end %>
  </div>

  <%# æ–°è¦è¿½åŠ  %>
  <% if session[:user_id] %>
    <div class="bottom-action">
      <%= link_to 'æ–°è¦è¿½åŠ ', new_shop_path, class: "new-shop-link" %>
    </div>
  <% end %>

</div>